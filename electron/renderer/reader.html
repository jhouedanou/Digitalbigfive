<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Lecteur â€” Big Five Digital</title>
  <link rel="stylesheet" href="styles.css">
  <style>
    body { overflow: hidden; }

    /* â”€â”€â”€ Reader Layout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .reader-wrapper {
      display: flex;
      flex-direction: column;
      height: 100vh;
      background: #111;
    }

    .reader-header {
      background: rgba(0,0,0,0.6);
      backdrop-filter: blur(20px);
      padding: 8px 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid rgba(255,255,255,0.08);
      z-index: 50;
      -webkit-app-region: drag;
    }
    .reader-header * { -webkit-app-region: no-drag; }

    .reader-header-left {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .reader-title {
      font-size: 14px;
      font-weight: 500;
      color: var(--text-secondary);
      max-width: 400px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .reader-header-right {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .reader-header .btn-icon {
      width: 32px;
      height: 32px;
      font-size: 14px;
    }

    .mode-btn {
      padding: 4px 10px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 500;
      border: 1px solid rgba(255,255,255,0.15);
      background: rgba(128,54,141,0.4);
      color: white;
      cursor: pointer;
      transition: all 0.2s;
    }
    .mode-btn:hover { background: rgba(128,54,141,0.7); }
    .mode-btn.active { background: var(--accent); }

    /* â”€â”€â”€ Pages Area â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .reader-viewport {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      overflow: hidden;
      background: #0d0d0d;
    }

    .pages-container {
      display: flex;
      gap: 4px;
      transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .page-canvas {
      max-height: calc(100vh - 100px);
      box-shadow: 0 4px 20px rgba(0,0,0,0.6);
      background: white;
    }

    /* Classic (scroll) mode */
    .reader-viewport.classic-mode {
      overflow-y: auto;
      align-items: flex-start;
    }
    .reader-viewport.classic-mode .pages-container {
      flex-direction: column;
      gap: 8px;
      padding: 20px;
      align-items: center;
    }

    /* â”€â”€â”€ Navigation Arrows â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .nav-arrow {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      width: 52px;
      height: 52px;
      border-radius: 50%;
      background: rgba(0,0,0,0.4);
      border: 1px solid rgba(255,255,255,0.1);
      color: white;
      font-size: 22px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      z-index: 20;
    }
    .nav-arrow:hover { background: rgba(0,0,0,0.7); border-color: rgba(255,255,255,0.25); }
    .nav-arrow:disabled { opacity: 0.2; cursor: not-allowed; }
    .nav-arrow.left { left: 16px; }
    .nav-arrow.right { right: 16px; }

    /* â”€â”€â”€ Click zones (invisible) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .click-zone {
      position: absolute;
      top: 0;
      bottom: 60px;
      width: 30%;
      z-index: 15;
      cursor: pointer;
    }
    .click-zone.left { left: 0; }
    .click-zone.right { right: 0; }

    /* â”€â”€â”€ Footer / Progress â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .reader-bottom {
      background: rgba(0,0,0,0.6);
      backdrop-filter: blur(10px);
      padding: 6px 20px 8px;
      border-top: 1px solid rgba(255,255,255,0.08);
    }

    .progress-track {
      width: 100%;
      height: 3px;
      background: var(--bg-tertiary);
      border-radius: 2px;
      overflow: hidden;
      margin-bottom: 4px;
      cursor: pointer;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--accent), var(--accent-blue));
      transition: width 0.3s;
    }

    .reader-status {
      display: flex;
      justify-content: space-between;
      font-size: 11px;
      color: var(--text-muted);
    }

    /* â”€â”€â”€ Watermark â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .watermark-overlay {
      position: absolute;
      inset: 0;
      pointer-events: none;
      z-index: 30;
      overflow: hidden;
    }

    .watermark-text {
      position: absolute;
      white-space: nowrap;
      font-size: 14px;
      color: rgba(128, 54, 141, 0.06);
      transform: rotate(-35deg);
      font-weight: 600;
      user-select: none;
    }

    /* â”€â”€â”€ Page Flip Animation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    @keyframes flipRight {
      0% { transform: perspective(1200px) rotateY(0deg); }
      100% { transform: perspective(1200px) rotateY(-180deg); }
    }

    @keyframes flipLeft {
      0% { transform: perspective(1200px) rotateY(-180deg); }
      100% { transform: perspective(1200px) rotateY(0deg); }
    }

    .flipping-right {
      animation: flipRight 0.5s ease-in-out;
      transform-origin: left center;
    }

    .flipping-left {
      animation: flipLeft 0.5s ease-in-out;
      transform-origin: right center;
    }

    /* â”€â”€â”€ Download Banner â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .download-banner {
      display: none;
      background: linear-gradient(135deg, rgba(128,54,141,0.2), rgba(41,53,139,0.2));
      border: 1px solid rgba(128,54,141,0.3);
      padding: 8px 16px;
      font-size: 12px;
      color: var(--text-secondary);
      align-items: center;
      justify-content: space-between;
    }
    .download-banner.visible { display: flex; }
    .download-banner button {
      padding: 4px 12px;
      border-radius: 6px;
      border: none;
      background: var(--accent);
      color: white;
      font-size: 11px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div class="reader-wrapper">
    <!-- Header -->
    <div class="reader-header">
      <div class="reader-header-left">
        <button class="btn-icon" id="back-btn" title="Retour Ã  la bibliothÃ¨que">â†</button>
        <span class="reader-title" id="book-title">Chargement...</span>
      </div>
      <div class="reader-header-right">
        <button class="mode-btn" id="mode-toggle" title="Mode de lecture">ğŸ“– Livre</button>
        <button class="btn-icon" id="zoom-out" title="Zoom -">âˆ’</button>
        <span id="zoom-level" style="font-size:11px;color:var(--text-muted);min-width:36px;text-align:center;">100%</span>
        <button class="btn-icon" id="zoom-in" title="Zoom +">+</button>
        <button class="btn-icon" id="fullscreen-btn" title="Plein Ã©cran">â›¶</button>
      </div>
    </div>

    <!-- Download prompt -->
    <div class="download-banner" id="download-banner">
      <span>ğŸ’¡ TÃ©lÃ©chargez ce livre pour le lire hors-ligne</span>
      <button id="banner-download">â¬‡ï¸ TÃ©lÃ©charger</button>
    </div>

    <!-- Viewport -->
    <div class="reader-viewport" id="viewport">
      <!-- Click zones for navigation -->
      <div class="click-zone left" id="click-prev"></div>
      <div class="click-zone right" id="click-next"></div>

      <!-- Navigation arrows -->
      <button class="nav-arrow left" id="prev-btn" disabled>â€¹</button>
      <button class="nav-arrow right" id="next-btn" disabled>â€º</button>

      <!-- Pages -->
      <div class="pages-container" id="pages-container"></div>

      <!-- Watermark -->
      <div class="watermark-overlay" id="watermark"></div>

      <!-- Loading -->
      <div id="reader-loading" class="loading-screen" style="position:absolute;inset:0;background:rgba(0,0,0,0.8);">
        <div class="spinner"></div>
        <p style="color:var(--text-muted)">Chargement du livre...</p>
        <p id="load-progress" style="color:var(--text-muted);font-size:12px;"></p>
      </div>
    </div>

    <!-- Footer -->
    <div class="reader-bottom">
      <div class="progress-track" id="progress-track">
        <div class="progress-fill" id="progress-fill"></div>
      </div>
      <div class="reader-status">
        <span id="page-info">â€” / â€”</span>
        <span id="spread-info"></span>
        <span id="percent-info">0%</span>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="toast"></div>

  <!-- pdf.js & Supabase loaded locally (no CDN dependency) -->
  <script src="./supabase.min.js"></script>

  <script type="module">
    // â”€â”€â”€ pdf.js Setup (local files) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const pdfjsLib = await import("./pdf.min.mjs");
    pdfjsLib.GlobalWorkerOptions.workerSrc = "./pdf.worker.min.mjs";

    // â”€â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    let pdfDoc = null;
    let totalPages = 0;
    let currentPage = 1;         // 1-based, single page
    let currentSpread = 0;       // 0-based, spread index
    let scale = 1.0;
    let readingMode = "book";    // "book" or "classic"
    let pageImages = new Map();  // pageNum -> dataURL
    let bookId = null;
    let bookTitle = "";
    let accessToken = null;
    let appConfig = null;
    let isFlipping = false;
    let userEmail = "";
    let isDownloaded = false;
    let supabaseClient = null;

    // â”€â”€â”€ DOM Elements â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const $viewport = document.getElementById("viewport");
    const $container = document.getElementById("pages-container");
    const $loading = document.getElementById("reader-loading");
    const $loadProgress = document.getElementById("load-progress");
    const $prevBtn = document.getElementById("prev-btn");
    const $nextBtn = document.getElementById("next-btn");
    const $pageInfo = document.getElementById("page-info");
    const $spreadInfo = document.getElementById("spread-info");
    const $percentInfo = document.getElementById("percent-info");
    const $progressFill = document.getElementById("progress-fill");
    const $progressTrack = document.getElementById("progress-track");
    const $zoomLevel = document.getElementById("zoom-level");
    const $modeToggle = document.getElementById("mode-toggle");
    const $bookTitle = document.getElementById("book-title");
    const $downloadBanner = document.getElementById("download-banner");

    // â”€â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // Pending book data in case open-book arrives before init completes
    let pendingBookData = null;

    // Register onOpenBook listener IMMEDIATELY (before any async work)
    // to avoid missing the event from main process
    window.electronAPI.onOpenBook((data) => {
      console.log("[READER] Received open-book:", data.bookId, data.title);
      if (!appConfig) {
        // init() hasn't finished yet, store for later
        pendingBookData = data;
      } else {
        handleOpenBook(data);
      }
    });

    async function handleOpenBook(data) {
      bookId = data.bookId;
      bookTitle = data.title;
      $bookTitle.textContent = bookTitle || "Lecteur";
      await loadPDF();
    }

    async function init() {
      console.log("[READER] init() starting...");
      appConfig = await window.electronAPI.getConfig();
      console.log("[READER] config loaded:", appConfig.apiUrl);
      supabaseClient = window.supabase.createClient(appConfig.supabaseUrl, appConfig.supabaseKey);

      // Restore reading mode
      try {
        const saved = localStorage.getItem("electron-reading-mode");
        if (saved === "book" || saved === "classic") readingMode = saved;
      } catch {}

      updateModeButton();

      // Get auth
      const { data: { session } } = await supabaseClient.auth.getSession();
      if (!session?.access_token) {
        window.electronAPI.navigate("login.html");
        return;
      }
      accessToken = session.access_token;
      userEmail = session.user?.email || "";

      console.log("[READER] init() complete, checking pending book...");

      // If open-book arrived before init completed, process it now
      if (pendingBookData) {
        console.log("[READER] Processing pending book:", pendingBookData.bookId);
        const data = pendingBookData;
        pendingBookData = null;
        await handleOpenBook(data);
      }
    }

    // â”€â”€â”€ Load PDF â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function loadPDF() {
      console.log("[READER] loadPDF() called for bookId:", bookId);
      $loading.style.display = "flex";
      pageImages.clear();

      try {
        // Try local first
        console.log("[READER] Trying local PDF...");
        const local = await window.electronAPI.readLocalPdf(bookId);
        if (local.success && local.data) {
          isDownloaded = true;
          $loadProgress.textContent = "Lecture depuis le stockage local...";
          console.log("[READER] Local PDF found, data type:", typeof local.data, "length:", local.data.length || local.data.byteLength || "unknown");
          // Ensure data is a proper Uint8Array (IPC serialization may convert it)
          let pdfData = local.data;
          if (!(pdfData instanceof Uint8Array)) {
            console.log("[READER] Converting data to Uint8Array...");
            if (pdfData.buffer) {
              pdfData = new Uint8Array(pdfData.buffer);
            } else if (typeof pdfData === "object") {
              pdfData = new Uint8Array(Object.values(pdfData));
            }
          }
          pdfDoc = await pdfjsLib.getDocument({ data: pdfData }).promise;
        } else {
          // Stream from API
          isDownloaded = false;
          $loadProgress.textContent = "TÃ©lÃ©chargement depuis le serveur...";
          const url = `${appConfig.apiUrl}/api/pdf/${bookId}`;
          console.log("[READER] Fetching PDF from:", url);
          pdfDoc = await pdfjsLib.getDocument({
            url,
            httpHeaders: { Authorization: `Bearer ${accessToken}` },
          }).promise;
        }

        totalPages = pdfDoc.numPages;
        currentPage = 1;
        currentSpread = 0;

        // Show download banner if not downloaded
        if (!isDownloaded) {
          $downloadBanner.classList.add("visible");
        }

        // Pre-render all pages
        $loadProgress.textContent = "Rendu des pages...";
        await renderAllPages();

        // Generate watermark
        generateWatermark();

        // Display
        $loading.style.display = "none";
        displayCurrentView();
        updateUI();

      } catch (err) {
        console.error("[READER] PDF load error:", err);
        $loadProgress.textContent = `Erreur: ${err.message || err}`;
        showToast("âŒ Impossible de charger le PDF", "error");
      }
    }

    // â”€â”€â”€ Render all pages to images â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function renderAllPages() {
      const renderScale = 2; // High resolution
      for (let i = 1; i <= totalPages; i++) {
        $loadProgress.textContent = `Rendu page ${i} / ${totalPages}`;
        const page = await pdfDoc.getPage(i);
        const vp = page.getViewport({ scale: renderScale });
        const canvas = document.createElement("canvas");
        canvas.width = vp.width;
        canvas.height = vp.height;
        const ctx = canvas.getContext("2d");
        await page.render({ canvasContext: ctx, viewport: vp }).promise;
        pageImages.set(i, canvas.toDataURL("image/jpeg", 0.92));
      }
    }

    // â”€â”€â”€ Display current view â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function displayCurrentView() {
      $container.innerHTML = "";

      if (readingMode === "classic") {
        displayClassicMode();
      } else {
        displayBookMode();
      }
    }

    // â”€â”€â”€ Book mode: show spread (2 pages side by side) â”€â”€â”€â”€â”€â”€
    function displayBookMode() {
      $viewport.classList.remove("classic-mode");
      
      const leftPageNum = currentSpread * 2 + 1;
      const rightPageNum = leftPageNum + 1;

      // Left page
      if (leftPageNum <= totalPages) {
        const img = createPageImage(leftPageNum);
        img.style.borderRadius = "2px 0 0 2px";
        $container.appendChild(img);
      }

      // Right page
      if (rightPageNum <= totalPages) {
        const img = createPageImage(rightPageNum);
        img.style.borderRadius = "0 2px 2px 0";
        $container.appendChild(img);
      }

      $container.style.transform = `scale(${scale})`;
    }

    // â”€â”€â”€ Classic mode: show single page â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function displayClassicMode() {
      $viewport.classList.add("classic-mode");

      const img = createPageImage(currentPage);
      $container.appendChild(img);
      $container.style.transform = `scale(${scale})`;
    }

    // â”€â”€â”€ Create page image element â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function createPageImage(pageNum) {
      const img = document.createElement("img");
      img.src = pageImages.get(pageNum) || "";
      img.className = "page-canvas";
      img.draggable = false;
      img.style.maxWidth = readingMode === "book" ? "48vw" : "80vw";
      img.alt = `Page ${pageNum}`;
      return img;
    }

    // â”€â”€â”€ Navigation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function goNext() {
      if (isFlipping) return;

      if (readingMode === "book") {
        const maxSpread = Math.ceil(totalPages / 2) - 1;
        if (currentSpread >= maxSpread) return;
        animateFlip("right", () => {
          currentSpread++;
          currentPage = currentSpread * 2 + 1;
          displayCurrentView();
          updateUI();
        });
      } else {
        if (currentPage >= totalPages) return;
        currentPage++;
        currentSpread = Math.floor((currentPage - 1) / 2);
        displayCurrentView();
        updateUI();
      }
    }

    function goPrev() {
      if (isFlipping) return;

      if (readingMode === "book") {
        if (currentSpread <= 0) return;
        animateFlip("left", () => {
          currentSpread--;
          currentPage = currentSpread * 2 + 1;
          displayCurrentView();
          updateUI();
        });
      } else {
        if (currentPage <= 1) return;
        currentPage--;
        currentSpread = Math.floor((currentPage - 1) / 2);
        displayCurrentView();
        updateUI();
      }
    }

    function goToPage(pageNum) {
      pageNum = Math.max(1, Math.min(totalPages, pageNum));
      currentPage = pageNum;
      currentSpread = Math.floor((pageNum - 1) / 2);
      displayCurrentView();
      updateUI();
    }

    // â”€â”€â”€ Flip animation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function animateFlip(direction, callback) {
      isFlipping = true;
      const pages = $container.querySelectorAll(".page-canvas");
      const target = direction === "right" ? pages[pages.length - 1] : pages[0];
      
      if (target) {
        target.classList.add(direction === "right" ? "flipping-right" : "flipping-left");
        setTimeout(() => {
          target.classList.remove("flipping-right", "flipping-left");
          isFlipping = false;
          callback();
        }, 400);
      } else {
        isFlipping = false;
        callback();
      }
    }

    // â”€â”€â”€ Update UI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function updateUI() {
      // Navigation buttons
      if (readingMode === "book") {
        $prevBtn.disabled = currentSpread <= 0;
        $nextBtn.disabled = currentSpread >= Math.ceil(totalPages / 2) - 1;
        
        const leftPage = currentSpread * 2 + 1;
        const rightPage = Math.min(leftPage + 1, totalPages);
        $pageInfo.textContent = leftPage === rightPage
          ? `Page ${leftPage} / ${totalPages}`
          : `Pages ${leftPage}-${rightPage} / ${totalPages}`;
        $spreadInfo.textContent = `Planche ${currentSpread + 1} / ${Math.ceil(totalPages / 2)}`;
      } else {
        $prevBtn.disabled = currentPage <= 1;
        $nextBtn.disabled = currentPage >= totalPages;
        $pageInfo.textContent = `Page ${currentPage} / ${totalPages}`;
        $spreadInfo.textContent = "";
      }

      // Progress
      const progress = readingMode === "book"
        ? ((currentSpread + 1) / Math.ceil(totalPages / 2)) * 100
        : (currentPage / totalPages) * 100;
      $progressFill.style.width = progress + "%";
      $percentInfo.textContent = Math.round(progress) + "%";

      // Zoom
      $zoomLevel.textContent = Math.round(scale * 100) + "%";

      // Hide arrows in classic mode
      $prevBtn.style.display = readingMode === "classic" ? "none" : "";
      $nextBtn.style.display = readingMode === "classic" ? "none" : "";
      document.getElementById("click-prev").style.display = readingMode === "classic" ? "none" : "";
      document.getElementById("click-next").style.display = readingMode === "classic" ? "none" : "";
    }

    // â”€â”€â”€ Watermark â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function generateWatermark() {
      const overlay = document.getElementById("watermark");
      overlay.innerHTML = "";
      if (!userEmail) return;

      for (let y = 0; y < 8; y++) {
        for (let x = 0; x < 5; x++) {
          const span = document.createElement("span");
          span.className = "watermark-text";
          span.textContent = userEmail;
          span.style.left = (x * 25 + (y % 2) * 12) + "%";
          span.style.top = (y * 14 + 2) + "%";
          overlay.appendChild(span);
        }
      }
    }

    // â”€â”€â”€ Mode toggle â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function toggleMode() {
      if (readingMode === "book") {
        readingMode = "classic";
        currentPage = currentSpread * 2 + 1;
      } else {
        readingMode = "book";
        currentSpread = Math.floor((currentPage - 1) / 2);
      }
      localStorage.setItem("electron-reading-mode", readingMode);
      updateModeButton();
      displayCurrentView();
      updateUI();
    }

    function updateModeButton() {
      $modeToggle.textContent = readingMode === "book" ? "ğŸ“– Livre" : "ğŸ“„ Classique";
      $modeToggle.classList.toggle("active", readingMode === "book");
    }

    // â”€â”€â”€ Zoom â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function zoomIn() {
      scale = Math.min(3, scale + 0.15);
      $container.style.transform = `scale(${scale})`;
      $zoomLevel.textContent = Math.round(scale * 100) + "%";
    }

    function zoomOut() {
      scale = Math.max(0.3, scale - 0.15);
      $container.style.transform = `scale(${scale})`;
      $zoomLevel.textContent = Math.round(scale * 100) + "%";
    }

    // â”€â”€â”€ Fullscreen â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function toggleFullscreen() {
      if (document.fullscreenElement) {
        document.exitFullscreen();
      } else {
        document.documentElement.requestFullscreen();
      }
    }

    // â”€â”€â”€ Download â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function downloadForOffline() {
      if (!bookId || !accessToken) return;
      showToast("â¬‡ï¸ TÃ©lÃ©chargement en cours...", "");
      const result = await window.electronAPI.downloadPdf(bookId, accessToken);
      if (result.success) {
        isDownloaded = true;
        $downloadBanner.classList.remove("visible");
        const sizeMB = (result.size / (1024 * 1024)).toFixed(1);
        showToast(`âœ… TÃ©lÃ©chargÃ© ! (${sizeMB} Mo)`, "success");
      } else {
        showToast(`âŒ Ã‰chec : ${result.error}`, "error");
      }
    }

    // â”€â”€â”€ Toast â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function showToast(msg, type) {
      const toast = document.getElementById("toast");
      toast.textContent = msg;
      toast.className = `toast visible ${type || ""}`;
      setTimeout(() => toast.classList.remove("visible"), 3000);
    }

    // â”€â”€â”€ Progress bar click â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    $progressTrack.addEventListener("click", (e) => {
      const rect = $progressTrack.getBoundingClientRect();
      const ratio = (e.clientX - rect.left) / rect.width;
      const targetPage = Math.max(1, Math.ceil(ratio * totalPages));
      goToPage(targetPage);
    });

    // â”€â”€â”€ Event Listeners â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    document.getElementById("back-btn").addEventListener("click", () => {
      window.electronAPI.navigate("library.html");
    });

    $prevBtn.addEventListener("click", goPrev);
    $nextBtn.addEventListener("click", goNext);
    document.getElementById("click-prev").addEventListener("click", goPrev);
    document.getElementById("click-next").addEventListener("click", goNext);

    document.getElementById("zoom-in").addEventListener("click", zoomIn);
    document.getElementById("zoom-out").addEventListener("click", zoomOut);
    document.getElementById("fullscreen-btn").addEventListener("click", toggleFullscreen);
    $modeToggle.addEventListener("click", toggleMode);
    document.getElementById("banner-download").addEventListener("click", downloadForOffline);

    // Keyboard
    document.addEventListener("keydown", (e) => {
      if (e.key === "ArrowRight" || e.key === " ") { e.preventDefault(); goNext(); }
      if (e.key === "ArrowLeft") { e.preventDefault(); goPrev(); }
      if (e.key === "Home") { goToPage(1); }
      if (e.key === "End") { goToPage(totalPages); }
      if (e.key === "+" || e.key === "=") { e.preventDefault(); zoomIn(); }
      if (e.key === "-") { e.preventDefault(); zoomOut(); }
      if (e.key === "f" || e.key === "F") { toggleFullscreen(); }
      if (e.key === "Escape") {
        if (document.fullscreenElement) document.exitFullscreen();
        else window.electronAPI.navigate("library.html");
      }
    });

    // Mouse wheel zoom
    $viewport.addEventListener("wheel", (e) => {
      if (e.ctrlKey) {
        e.preventDefault();
        if (e.deltaY < 0) zoomIn();
        else zoomOut();
      } else if (readingMode === "book") {
        // Scroll to navigate in book mode
        if (e.deltaY > 30) goNext();
        else if (e.deltaY < -30) goPrev();
      }
    }, { passive: false });

    // â”€â”€â”€ Start â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    init();
  </script>
</body>
</html>
